# !/usr/bin/env python3
# -*- coding: utf-8 -*-

from src.art import *
from src.print import *
from src.utilities import *

from os import path, makedirs
from datetime import datetime


class GetPwds:
    def __init__(self):
        self.time = datetime.now()
        self.wifi_list = []
        banner()
        self.main()

    def main(self):
        from subprocess import run
        from re import findall, search

        command_output = run(
            ["netsh", "wlan", "show", "profiles"], capture_output=True).stdout.decode()
        profile_names = (
            findall("All User Profile     : (.*)\r", command_output))

        if len(profile_names) != 0:
            for name in profile_names:
                wifi_profile = {}
                profile_info = run(
                    ["netsh", "wlan", "show", "profile", name], capture_output=True).stdout.decode()

                if search("Security key           : Absent", profile_info):
                    continue
                else:
                    wifi_profile["ssid"] = name
                    profile_info_pass = run(
                        ["netsh", "wlan", "show", "profile", name, "key=clear"], capture_output=True).stdout.decode()
                    password = search(
                        "Key Content            : (.*)\r", profile_info_pass)

                    if password == None:
                        wifi_profile["password"] = None
                    else:
                        wifi_profile["password"] = password[1]

                    self.wifi_list.append(wifi_profile)

        self.time = str(datetime.now() - self.time)

        printf("[1] GET PASSWORDS\n", BLUE)

        for x in range(len(self.wifi_list)):
            _ = self.wifi_list[x].get("ssid")
            __ = self.wifi_list[x].get("password")
            printf(f"{_}:{__}\n")

        sep()
        printf(f"[+] Scanning completed in {self.time}...\n", BLUE)

        sep()
        printf("Save it?\t[Y]es / [N]o\n")
        printf("$~> ")
        x = str(input("")).lower()

        sep()
        if x == "y" or x == "ye" or x == "yes" or x == "oui":
            folder = "./output/wexploit/"
            filename = f"wpwds_{int(datetime.timestamp(datetime.now()))}.txt"
            filepath = path.join(folder, filename)
            if not path.isdir(folder):
                makedirs(folder)

            f = open(filepath, "w+")
            f.write(f"[*] WPWDS FOR {datetime.now()}\n")
            for x in range(len(self.wifi_list)):
                _ = self.wifi_list[x].get("ssid")
                __ = self.wifi_list[x].get("password")
                f.write(f"{_}:{__}\n")
            f.close()

            printf(f"[+] Saved to: {filepath}\n", BLUE)
            sep()
        pause()
